> æˆ‘å°†ä»‹ç»ä¸€äº› MySQL é«˜çº§æŸ¥è¯¢çš„çŸ¥è¯†ï¼ŒåŒ…æ‹¬å­æŸ¥è¯¢ã€è”æ¥ã€è”åˆæŸ¥è¯¢ã€çª—å£å‡½æ•°ã€å­˜å‚¨è¿‡ç¨‹å’Œè§¦å‘å™¨ç­‰é«˜çº§ä¸»é¢˜ã€‚ğŸš€

<iframe allow="autoplay *; encrypted-media *;" frameborder="0" height="150" style="width:100%;max-width:880px;overflow:hidden;background:transparent;" sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-storage-access-by-user-activation allow-top-navigation-by-user-activation" src="https://embed.music.apple.com/cn/album/%E5%8B%BF%E5%BF%98%E5%BF%83%E5%AE%89-live/1696223112?i=1696223567"></iframe>

![](https://photohosting.oss-cn-hangzhou.aliyuncs.com/notionCover/4c1b704ee20e4b5fa28fcac2a82a32d5.jpg)

## åŸºæœ¬æ¦‚è¿°

### 1. å­æŸ¥è¯¢ï¼ˆSubqueriesï¼‰

å­æŸ¥è¯¢æ˜¯ä¸€ä¸ªåµŒå¥—åœ¨å¦ä¸€ä¸ªæŸ¥è¯¢ä¸­çš„æŸ¥è¯¢ï¼Œé€šå¸¸ç”¨äºå¤æ‚çš„æŸ¥è¯¢æ¡ä»¶ã€‚

**ä¾‹å­ï¼š**
```sql
-- æŸ¥è¯¢å·¥èµ„é«˜äºå¹³å‡å·¥èµ„çš„å‘˜å·¥
SELECT *
FROM employees
WHERE salary > (SELECT AVG(salary) FROM employees);
```

### 2. è”æ¥ï¼ˆJoinsï¼‰
è”æ¥ç”¨äºä»å¤šä¸ªè¡¨ä¸­æ£€ç´¢æ•°æ®ã€‚æœ€å¸¸è§çš„è”æ¥ç±»å‹æœ‰å†…è”æ¥ï¼ˆINNER JOINï¼‰ã€å·¦è”æ¥ï¼ˆLEFT JOINï¼‰ã€å³è”æ¥ï¼ˆRIGHT JOINï¼‰å’Œå…¨å¤–éƒ¨è”æ¥ï¼ˆFULL OUTER JOINï¼‰ã€‚

**ä¾‹å­ï¼š**
```sql
-- å†…è”æ¥
SELECT employees.name, departments.department_name
FROM employees
INNER JOIN departments ON employees.department_id = departments.id;

-- å·¦è”æ¥
SELECT employees.name, departments.department_name
FROM employees
LEFT JOIN departments ON employees.department_id = departments.id;
```

### 3. è”åˆæŸ¥è¯¢ï¼ˆUNION å’Œ UNION ALLï¼‰
è”åˆæŸ¥è¯¢ç”¨äºåˆå¹¶å¤šä¸ª SELECT è¯­å¥çš„ç»“æœé›†ã€‚`UNION` ä¼šå»é™¤é‡å¤çš„è®°å½•ï¼Œè€Œ `UNION ALL` åˆ™ä¿ç•™æ‰€æœ‰è®°å½•ã€‚

**ä¾‹å­ï¼š**
```sql
-- UNION
SELECT name FROM employees
UNION
SELECT name FROM managers;

-- UNION ALL
SELECT name FROM employees
UNION ALL
SELECT name FROM managers;
```

### 4. çª—å£å‡½æ•°ï¼ˆWindow Functionsï¼‰
çª—å£å‡½æ•°æ‰§è¡Œè®¡ç®—æ“ä½œå¹¶è¿”å›åŸºäºä¸€ç»„è¡Œçš„ç»“æœï¼Œä¸èšåˆå‡½æ•°ä¸åŒçš„æ˜¯ï¼Œçª—å£å‡½æ•°ä¸ä¼šå¯¹å¤šè¡Œè¿›è¡Œåˆ†ç»„ã€‚

**ä¾‹å­ï¼š**
```sql
-- ä½¿ç”¨ ROW_NUMBER() çª—å£å‡½æ•°ä¸ºæ¯ä¸ªå‘˜å·¥åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„è¡Œå·
SELECT employee_id, salary,
       ROW_NUMBER() OVER (PARTITION BY department_id ORDER BY salary DESC) as rank
FROM employees;

-- ä½¿ç”¨ AVG() çª—å£å‡½æ•°è®¡ç®—éƒ¨é—¨å†…çš„å¹³å‡å·¥èµ„
SELECT employee_id, department_id, salary,
       AVG(salary) OVER (PARTITION BY department_id) as avg_department_salary
FROM employees;
```

### 5. å­˜å‚¨è¿‡ç¨‹ï¼ˆStored Proceduresï¼‰
å­˜å‚¨è¿‡ç¨‹æ˜¯ä¸€ç»„é¢„ç¼–è¯‘çš„ SQL è¯­å¥ï¼Œå¯ä»¥å°è£…ä¸šåŠ¡é€»è¾‘ï¼Œæé«˜ä»£ç çš„é‡ç”¨æ€§å’Œç»´æŠ¤æ€§ã€‚

**ä¾‹å­ï¼š**
```sql
DELIMITER //

CREATE PROCEDURE GetEmployeeById(IN emp_id INT)
BEGIN
    SELECT * FROM employees WHERE employee_id = emp_id;
END //

DELIMITER ;

-- è°ƒç”¨å­˜å‚¨è¿‡ç¨‹
CALL GetEmployeeById(101);
```

### 6. è§¦å‘å™¨ï¼ˆTriggersï¼‰
è§¦å‘å™¨æ˜¯åœ¨ç‰¹å®šäº‹ä»¶å‘ç”Ÿæ—¶è‡ªåŠ¨æ‰§è¡Œçš„ SQL ä»£ç å—ï¼Œä¾‹å¦‚åœ¨è¡¨æ’å…¥ã€æ›´æ–°æˆ–åˆ é™¤æ—¶è§¦å‘ã€‚

**ä¾‹å­ï¼š**
```sql
-- åˆ›å»ºä¸€ä¸ªåœ¨æ›´æ–°å‘˜å·¥è–ªæ°´æ—¶è§¦å‘çš„è§¦å‘å™¨
CREATE TRIGGER before_salary_update
BEFORE UPDATE ON employees
FOR EACH ROW
BEGIN
    IF NEW.salary > OLD.salary THEN
        INSERT INTO salary_changes(employee_id, old_salary, new_salary, change_date)
        VALUES (OLD.employee_id, OLD.salary, NEW.salary, NOW());
    END IF;
END;
```

### 7. ç´¢å¼•ï¼ˆIndexesï¼‰
ç´¢å¼•å¯ä»¥åŠ é€Ÿæ•°æ®åº“æŸ¥è¯¢ï¼Œä½†ä¹Ÿä¼šå¢åŠ å†™æ“ä½œçš„å¼€é”€ã€‚å› æ­¤ï¼Œéœ€è¦åˆç†ä½¿ç”¨ç´¢å¼•ã€‚

**ä¾‹å­ï¼š**
```sql
-- ä¸º employees è¡¨çš„ employee_id åˆ—åˆ›å»ºä¸€ä¸ªç´¢å¼•
CREATE INDEX idx_employee_id ON employees(employee_id);
```

### 8. è§†å›¾ï¼ˆViewsï¼‰
è§†å›¾æ˜¯åŸºäº SQL æŸ¥è¯¢ç»“æœé›†çš„è™šæ‹Ÿè¡¨ï¼Œå…è®¸ä½ ç®€åŒ–å¤æ‚æŸ¥è¯¢å¹¶æé«˜ä»£ç çš„å¯è¯»æ€§ã€‚

**ä¾‹å­ï¼š**
```sql
-- åˆ›å»ºä¸€ä¸ªè§†å›¾æ˜¾ç¤ºé«˜è–ªå‘˜å·¥çš„ä¿¡æ¯
CREATE VIEW HighSalaryEmployees AS
SELECT name, department_id, salary
FROM employees
WHERE salary > 10000;

-- ä½¿ç”¨è§†å›¾æŸ¥è¯¢
SELECT * FROM HighSalaryEmployees;
```

### 9. åˆ†åŒºï¼ˆPartitioningï¼‰
åˆ†åŒºå°†å¤§è¡¨æ‹†åˆ†æˆæ›´å°çš„ã€ç‹¬ç«‹ç®¡ç†çš„éƒ¨åˆ†ï¼Œä»¥æé«˜æŸ¥è¯¢æ€§èƒ½ã€‚

**ä¾‹å­ï¼š**
```sql
-- åˆ›å»ºä¸€ä¸ªæŒ‰å¹´ä»½åˆ†åŒºçš„è¡¨
CREATE TABLE sales (
    sale_id INT,
    sale_date DATE,
    amount DECIMAL(10, 2)
)
PARTITION BY RANGE (YEAR(sale_date)) (
    PARTITION p0 VALUES LESS THAN (2022),
    PARTITION p1 VALUES LESS THAN (2023),
    PARTITION p2 VALUES LESS THAN (2024)
);
```

### 10. æƒé™ç®¡ç†ï¼ˆPermissionsï¼‰
æƒé™ç®¡ç†æ§åˆ¶ç”¨æˆ·åœ¨æ•°æ®åº“ä¸­çš„æ“ä½œæƒé™ã€‚

**ä¾‹å­ï¼š**
```sql
-- åˆ›å»ºç”¨æˆ·å¹¶æˆäºˆé€‰æ‹©æƒé™
CREATE USER 'new_user'@'localhost' IDENTIFIED BY 'password';
GRANT SELECT ON database_name.* TO 'new_user'@'localhost';

-- æ’¤é”€æƒé™
REVOKE SELECT ON database_name.* FROM 'new_user'@'localhost';
```

### 11. ä¼˜åŒ–æŸ¥è¯¢ï¼ˆQuery Optimizationï¼‰
ä¼˜åŒ–æŸ¥è¯¢å¯ä»¥æ˜¾è‘—æé«˜æ•°æ®åº“æ€§èƒ½ã€‚å¸¸è§çš„æ–¹æ³•åŒ…æ‹¬ä½¿ç”¨ç´¢å¼•ã€é¿å…å­æŸ¥è¯¢ã€ä¼˜åŒ–è”æ¥ç­‰ã€‚

**ä¾‹å­ï¼š**
```sql
-- æŸ¥çœ‹æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’
EXPLAIN SELECT * FROM employees WHERE salary > 5000;

```

## é¡¹ç›®å®æˆ˜

è®©æˆ‘ä»¬è®¾è®¡ä¸€ä¸ªæ¶‰åŠå¤šä¸ªé«˜çº§æŸ¥è¯¢æŠ€æœ¯çš„å®æˆ˜é¡¹ç›®ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåœ¨çº¿ä¹¦åº—çš„æ•°æ®åº“ï¼ŒåŒ…æ‹¬å¦‚ä¸‹å‡ ä¸ªè¡¨ï¼š

- `books`: å­˜å‚¨ä¹¦ç±ä¿¡æ¯
- `authors`: å­˜å‚¨ä½œè€…ä¿¡æ¯
- `orders`: å­˜å‚¨è®¢å•ä¿¡æ¯
- `customers`: å­˜å‚¨å®¢æˆ·ä¿¡æ¯
- `order_items`: å­˜å‚¨è®¢å•ä¸­çš„æ¯ä¸ªä¹¦ç±

### è¡¨ç»“æ„
1. `books` è¡¨ï¼š
    ```sql
    CREATE TABLE books (
        book_id INT PRIMARY KEY,
        title VARCHAR(255),
        author_id INT,
        price DECIMAL(10, 2),
        published_date DATE,
        stock INT
    );
    ```

2. `authors` è¡¨ï¼š
    ```sql
    CREATE TABLE authors (
        author_id INT PRIMARY KEY,
        name VARCHAR(255)
    );
    ```

3. `orders` è¡¨ï¼š
    ```sql
    CREATE TABLE orders (
        order_id INT PRIMARY KEY,
        customer_id INT,
        order_date DATE,
        status VARCHAR(50)
    );
    ```

4. `customers` è¡¨ï¼š
    ```sql
    CREATE TABLE customers (
        customer_id INT PRIMARY KEY,
        name VARCHAR(255),
        email VARCHAR(255)
    );
    ```

5. `order_items` è¡¨ï¼š
    ```sql
    CREATE TABLE order_items (
        order_item_id INT PRIMARY KEY,
        order_id INT,
        book_id INT,
        quantity INT,
        price DECIMAL(10, 2)
    );
    ```

å¥½çš„ï¼Œæˆ‘å¯ä»¥ä¸ºæ¯å¼ è¡¨å±•ç¤ºä¸€äº›é«˜çº§æŸ¥è¯¢ç¤ºä¾‹ï¼š

### 1. æŸ¥è¯¢ä¹¦ç±è¡¨ (`books`)

- **æŸ¥è¯¢æ‰€æœ‰ä¹¦ç±åŠå…¶ä½œè€…:**

```sql
SELECT b.book_id, b.title, a.name
FROM books b
JOIN authors a ON b.author_id = a.author_id;
```

- **æŒ‰ç…§ä»·æ ¼èŒƒå›´æŸ¥è¯¢ä¹¦ç±:**

```sql
SELECT *
FROM books
WHERE price BETWEEN 10.00 AND 50.00;
```

### 2. æŸ¥è¯¢ä½œè€…è¡¨ (`authors`)

- **æŸ¥è¯¢æ‰€æœ‰ä½œè€…åŠå…¶å†™è¿‡çš„ä¹¦ç±æ•°é‡:**

```sql
SELECT a.author_id, a.author_name, COUNT(b.book_id) AS books_written
FROM authors a
LEFT JOIN books b ON a.author_id = b.author_id
GROUP BY a.author_id, a.author_name;
```

- **æŒ‰ç…§ä½œè€…åå­—è¿›è¡Œæ¨¡ç³Šæœç´¢:**

```sql
SELECT *
FROM authors
WHERE author_name LIKE '%Smith%';
```

### 3. æŸ¥è¯¢è®¢å•è¡¨ (`orders`)

- **æŸ¥è¯¢ç‰¹å®šé¡¾å®¢çš„æ‰€æœ‰è®¢å•åŠè®¢å•æ€»é‡‘é¢:**

```sql
SELECT o.order_id, o.order_date, SUM(oi.quantity * oi.price) AS total_amount
FROM orders o
JOIN order_items oi ON o.order_id = oi.order_id
WHERE o.customer_id = 101
GROUP BY o.order_id, o.order_date;
```

- **æŸ¥è¯¢æŸä¸ªæ—¶é—´æ®µå†…çš„è®¢å•æ•°é‡å’Œæ€»é‡‘é¢:**

```sql
SELECT COUNT(order_id) AS num_orders, SUM(total_amount) AS total_sales
FROM (
    SELECT o.order_id, SUM(oi.quantity * oi.price) AS total_amount
    FROM orders o
    JOIN order_items oi ON o.order_id = oi.order_id
    WHERE o.order_date BETWEEN '2023-01-01' AND '2023-12-31'
    GROUP BY o.order_id
) AS order_summary;
```

### 4. æŸ¥è¯¢å®¢æˆ·è¡¨ (`customers`)

- **æŸ¥è¯¢å®¢æˆ·çš„è®¢å•æ•°é‡åŠæ€»é‡‘é¢:**

```sql
SELECT c.customer_id, c.name, COUNT(o.order_id) AS num_orders, SUM(oi.quantity * oi.price) AS total_spent
FROM customers c
LEFT JOIN orders o ON c.customer_id = o.customer_id
LEFT JOIN order_items oi ON o.order_id = oi.order_id
GROUP BY c.customer_id, c.name;
```

- **æŒ‰ç…§å®¢æˆ·æ³¨å†Œæ—¶é—´è¿›è¡Œæ’åº:**

```sql
SELECT *
FROM customers
ORDER BY registration_date DESC;
```

### 5. æŸ¥è¯¢è®¢å•é¡¹è¡¨ (`order_items`)

- **æŸ¥è¯¢æŸä¸ªè®¢å•çš„æ‰€æœ‰ä¹¦ç±åŠå…¶è¯¦ç»†ä¿¡æ¯:**

```sql
SELECT oi.order_item_id, b.title, oi.quantity, oi.price
FROM order_items oi
JOIN books b ON oi.book_id = b.book_id
WHERE oi.order_id = 1;
```

- **æŸ¥è¯¢é”€å”®é¢æœ€é«˜çš„ä¹¦ç±:**

```sql
SELECT b.book_id, b.title, SUM(oi.quantity * oi.price) AS total_sales
FROM order_items oi
JOIN books b ON oi.book_id = b.book_id
GROUP BY b.book_id, b.title
ORDER BY total_sales DESC
LIMIT 1;
```

è¿™äº›æŸ¥è¯¢å±•ç¤ºäº†å¦‚ä½•æ ¹æ®è¡¨çš„ç»“æ„å’Œå­—æ®µè¿›è¡Œå„ç§ç±»å‹çš„é«˜çº§æŸ¥è¯¢ï¼ŒåŒ…æ‹¬è¿æ¥å¤šå¼ è¡¨ã€èšåˆå‡½æ•°çš„ä½¿ç”¨ã€æ¡ä»¶ç­›é€‰å’Œæ’åºç­‰æ“ä½œã€‚ä½ å¯ä»¥æ ¹æ®å…·ä½“éœ€æ±‚è¿›ä¸€æ­¥è°ƒæ•´å’Œæ‰©å±•è¿™äº›æŸ¥è¯¢ã€‚
### å®æˆ˜ä»»åŠ¡

#### ä»»åŠ¡1ï¼šæŸ¥è¯¢æ€»é”€å”®é¢æœ€é«˜çš„ä¹¦ç±
æˆ‘ä»¬å°†ä½¿ç”¨å­æŸ¥è¯¢å’Œè”æ¥æ¥è®¡ç®—æ¯æœ¬ä¹¦ç±çš„æ€»é”€å”®é¢ï¼Œå¹¶æ‰¾å‡ºé”€å”®é¢æœ€é«˜çš„ä¹¦ç±ã€‚

```sql
SELECT b.title, SUM(oi.quantity * oi.price) AS total_sales
FROM order_items oi
JOIN books b ON oi.book_id = b.book_id
GROUP BY b.title
ORDER BY total_sales DESC
LIMIT 1;
```

#### ä»»åŠ¡2ï¼šæŸ¥æ‰¾æ¯ä¸ªä½œè€…çš„æ€»é”€å”®é¢
æˆ‘ä»¬å°†ä½¿ç”¨è”æ¥å’Œèšåˆå‡½æ•°æ¥è®¡ç®—æ¯ä¸ªä½œè€…çš„æ€»é”€å”®é¢ã€‚

```sql
SELECT a.name, SUM(oi.quantity * oi.price) AS total_sales
FROM authors a
JOIN books b ON a.author_id = b.author_id
JOIN order_items oi ON b.book_id = oi.book_id
GROUP BY a.name
ORDER BY total_sales DESC;
```

#### ä»»åŠ¡3ï¼šæŸ¥æ‰¾æ‰€æœ‰è®¢å•ä¸­åŒ…å«çš„ä¹¦ç±æ•°é‡è¶…è¿‡10æœ¬çš„è®¢å•
è¿™å°†ä½¿ç”¨è”æ¥å’Œ HAVING å­å¥ã€‚

```sql
SELECT o.order_id, SUM(oi.quantity) AS total_books
FROM orders o
JOIN order_items oi ON o.order_id = oi.order_id
GROUP BY o.order_id
HAVING total_books > 10;
```

#### ä»»åŠ¡4ï¼šåˆ›å»ºä¸€ä¸ªè§†å›¾ï¼Œæ˜¾ç¤ºæ¯ä¸ªå®¢æˆ·çš„è®¢å•å’Œä»–ä»¬è´­ä¹°çš„ä¹¦ç±
æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªè§†å›¾ï¼Œç®€åŒ–å¯¹å®¢æˆ·è®¢å•å’Œä¹¦ç±ä¿¡æ¯çš„æŸ¥è¯¢ã€‚

```sql
CREATE VIEW CustomerOrders AS
SELECT c.name AS customer_name, o.order_id, o.order_date, b.title, oi.quantity, oi.price
FROM customers c
JOIN orders o ON c.customer_id = o.customer_id
JOIN order_items oi ON o.order_id = oi.order_id
JOIN books b ON oi.book_id = b.book_id;

-- ä½¿ç”¨è§†å›¾
SELECT * FROM CustomerOrders WHERE customer_name = 'John Doe';
```

#### ä»»åŠ¡5ï¼šåˆ›å»ºä¸€ä¸ªå­˜å‚¨è¿‡ç¨‹ï¼ŒæŸ¥è¯¢ç‰¹å®šæ—¶é—´æ®µå†…çš„é”€å”®é¢
æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªå­˜å‚¨è¿‡ç¨‹ï¼Œæ ¹æ®è¾“å…¥çš„å¼€å§‹æ—¥æœŸå’Œç»“æŸæ—¥æœŸï¼Œè®¡ç®—è¯¥æ—¶é—´æ®µå†…çš„æ€»é”€å”®é¢ã€‚

```sql
DELIMITER //

CREATE PROCEDURE GetSalesByDateRange(IN start_date DATE, IN end_date DATE)
BEGIN
    SELECT SUM(oi.quantity * oi.price) AS total_sales
    FROM orders o
    JOIN order_items oi ON o.order_id = oi.order_id
    WHERE o.order_date BETWEEN start_date AND end_date;
END //

DELIMITER ;

-- è°ƒç”¨å­˜å‚¨è¿‡ç¨‹
CALL GetSalesByDateRange('2023-01-01', '2023-12-31');
```

#### ä»»åŠ¡6ï¼šä¸ºè®¢å•çŠ¶æ€æ›´æ–°åˆ›å»ºè§¦å‘å™¨
æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨è®¢å•çŠ¶æ€æ›´æ–°æ—¶è®°å½•æ›´æ–°å‰åçš„çŠ¶æ€ã€‚

```sql
CREATE TABLE order_status_changes (
    change_id INT PRIMARY KEY AUTO_INCREMENT,
    order_id INT,
    old_status VARCHAR(50),
    new_status VARCHAR(50),
    change_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

DELIMITER //

CREATE TRIGGER before_order_status_update
BEFORE UPDATE ON orders
FOR EACH ROW
BEGIN
    IF NEW.status <> OLD.status THEN
        INSERT INTO order_status_changes(order_id, old_status, new_status)
        VALUES (OLD.order_id, OLD.status, NEW.status);
    END IF;
END //

DELIMITER ;
```

### ä»»åŠ¡7ï¼šä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
ä¸º `books` è¡¨çš„ `title` åˆ—å’Œ `orders` è¡¨çš„ `order_date` åˆ—åˆ›å»ºç´¢å¼•ï¼Œä»¥åŠ é€ŸæŸ¥è¯¢ã€‚

```sql
CREATE INDEX idx_books_title ON books(title);
CREATE INDEX idx_orders_order_date ON orders(order_date);
```

### æ€»ç»“
é€šè¿‡ä¸Šè¿°ä»»åŠ¡ï¼Œä½ å°†ç»ƒä¹ å¤šä¸ª MySQL é«˜çº§æŸ¥è¯¢æŠ€æœ¯ï¼ŒåŒ…æ‹¬å­æŸ¥è¯¢ã€è”æ¥ã€è§†å›¾ã€å­˜å‚¨è¿‡ç¨‹ã€è§¦å‘å™¨ã€ç´¢å¼•ç­‰ã€‚è¿™äº›æŠ€æœ¯åœ¨å®é™…é¡¹ç›®ä¸­éå¸¸æœ‰ç”¨ï¼Œå¯ä»¥å¸®åŠ©ä½ æ›´é«˜æ•ˆåœ°ç®¡ç†å’Œæ“ä½œæ•°æ®åº“ã€‚
